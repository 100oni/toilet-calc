<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>„Éà„Ç§„É¨‰ªò„Åç„ÉªÈõªÂçì</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--btn:#1f2937;--muted:#94a3b8;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial;
      background:radial-gradient(1200px 600px at 50% -20%,#1e293b,var(--bg));color:var(--text);
      min-height:100vh;display:grid;place-items:center;padding:16px}
    .calc{width:min(780px,100%);background:linear-gradient(180deg,#0b1224,#111827);
      border:1px solid #26324a;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#0b1224;border-bottom:1px solid #1f2a3d}
    .brand{font-weight:700}
    .display{padding:16px;min-height:120px;display:grid;gap:10px;align-content:end;
      background:repeating-linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.03) 2px,transparent 2px,transparent 36px)}
    .expr{font-size:22px;color:var(--muted);word-break:break-all}
    .result{font-size:44px;font-weight:800;line-height:1.1;word-break:break-all}
    .grid{display:grid;gap:10px;padding:16px;background:#0c1428;grid-template-columns:repeat(4,1fr)}
    button{border:none;cursor:pointer;border-radius:14px;padding:14px 10px;font-size:22px;font-weight:700;background:#1f2937;color:var(--text);transition:transform .05s ease,filter .2s ease}
    button:hover{filter:brightness(1.06)}button:active{transform:translateY(1px)}
    .op{background:#182233}.accent{background:linear-gradient(180deg,#0ea5e9,#0284c7)}
    .danger{background:linear-gradient(180deg,#ef4444,#dc2626)}.wide{grid-column:span 2}.tall{grid-row:span 2}
    .funbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px 16px}
    .fun{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;background:#0b1224;border:1px dashed #1e293b;border-radius:14px;color:#94a3b8;font-weight:700}
    .poop{position:absolute;font-size:40px;pointer-events:none;animation:floatUp 1.2s ease forwards}
    @keyframes floatUp{from{transform:translateY(0) scale(1);opacity:1}to{transform:translateY(-80px) scale(.9);opacity:0}}
    .flushWave{position:absolute;inset:0;border-radius:18px;overflow:hidden;pointer-events:none}
    .flushWave::after{content:"";position:absolute;left:-120%;top:60%;width:140%;height:60%;
      background:radial-gradient(60% 120% at 50% 0%,rgba(56,189,248,.35),transparent 70%),linear-gradient(180deg,rgba(14,165,233,.35),rgba(2,132,199,.1));
      transform:rotate(-6deg) translateY(140%);animation:flush 900ms ease forwards}
    @keyframes flush{to{transform:rotate(-6deg) translateY(0%);opacity:0}}
  </style>
</head>
<body>
  <div class="calc" role="application" aria-label="„Éà„Ç§„É¨‰ªò„ÅçÈõªÂçì">
    <div class="topbar">
      <div class="brand">üßÆ „Éà„Ç§„É¨‰ªò„Åç„ÉªÈõªÂçì</div>
      <div style="font-size:12px;color:#94a3b8">„ÅÜ„Çì„Åìüí© / „Åπ„Çì„ÅçüöΩ „ÇíË£ÖÂÇô</div>
    </div>
    <div class="display" id="display">
      <div class="expr" id="expr">0</div>
      <div class="result" id="result">0</div>
    </div>
    <div class="grid" id="grid">
      <button class="danger" data-action="clear">AC</button>
      <button class="op" data-action="del">DEL</button>
      <button class="op" data-val="(">(</button>
      <button class="op" data-val=")">)</button>
      <button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button><button class="op" data-val="/">√∑</button>
      <button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button><button class="op" data-val="*">√ó</button>
      <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button><button class="op" data-val="-">‚àí</button>
      <button class="wide" data-val="0">0</button><button data-val=".">.</button><button class="op" data-val="+">Ôºã</button>
      <button class="accent tall" data-action="equals">Ôºù</button>
    </div>
    <div class="funbar">
      <button class="fun" id="poopBtn"><span style="font-size:22px">üí©</span> „ÅÜ„Çì„Åì„Éú„Çø„É≥</button>
      <button class="fun" id="toiletBtn"><span style="font-size:22px">üöΩ</span> „Åπ„Çì„Åç„Éú„Çø„É≥</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const exprEl = document.getElementById('expr');
      const resultEl = document.getElementById('result');
      const grid = document.getElementById('grid');
      const display = document.getElementById('display');
      if (!exprEl || !resultEl || !grid || !display) { console.error('Init failed'); return; }

      let expr = '';

      function formatNumber(n){
        return Math.abs(n) > 1e12 || (Math.abs(n) < 1e-6 && n !== 0)
          ? n.toString()
          : n.toLocaleString('ja-JP');
      }
      function sanitize(s){ return (s.match(/[0-9+\-*/(). ]/g) || []).join(''); }
      function evaluateSafe(s){
        const normalized = s.replace(/(?<!\\d)0+(\\d)/g,'$1');
        return Function('"use strict"; return (' + normalized + ');')();
      }
      function render(){
        exprEl.textContent = expr || '0';
        try{
          const safe = sanitize(expr);
          if (safe === '' || /[+\\-*/.(]$/.test(safe)) { resultEl.textContent = '0'; return; }
          const val = evaluateSafe(safe);
          resultEl.textContent = Number.isFinite(val) ? formatNumber(val) : '„Ç®„É©„Éº';
        }catch{ resultEl.textContent = '„Ç®„É©„Éº'; }
      }
      function appendVal(v){ expr += v; render(); }
      function delOne(){ expr = expr.slice(0,-1); render(); }
      function clearAll(){ expr=''; render(); }
      function doEquals(){
        try{
          const safe = sanitize(expr);
          if (!safe) return;
          const v = evaluateSafe(safe);
          if (Number.isFinite(v)) { expr = String(v); render(); }
        }catch{}
      }

      grid.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if (!btn) return;
        const val = btn.dataset.val; const action = btn.dataset.action;
        if (val) appendVal(val);
        else if (action==='del') delOne();
        else if (action==='clear') clearAll();
        else if (action==='equals') doEquals();
      });

      window.addEventListener('keydown', (e)=>{
        const allowed = '0123456789+-*/().';
        if (allowed.includes(e.key)) { appendVal(e.key); return; }
        if (e.key==='Enter' || e.key==='='){ e.preventDefault(); doEquals(); return; }
        if (e.key==='Backspace'){ delOne(); return; }
        if (e.key==='Escape'){ clearAll(); return; }
      });

      document.getElementById('poopBtn').addEventListener('click', ()=>{
        const rect = display.getBoundingClientRect();
        const x = Math.random()*(rect.width-40)+10;
        const y = rect.height-30;
        const node = document.createElement('div');
        node.className='poop'; node.style.left=x+'px'; node.style.top=y+'px';
        node.textContent='üí©'; node.style.position='absolute';
        display.style.position='relative'; display.appendChild(node);
        setTimeout(()=>node.remove(),1300);
      });

      document.getElementById('toiletBtn').addEventListener('click', ()=>{
        clearAll();
        const wave=document.createElement('div'); wave.className='flushWave';
        display.style.position='relative'; display.appendChild(wave);
        setTimeout(()=>wave.remove(),950);
      });

      render();
      console.log('Calculator ready');
    });
  </script>
</body>
</html>
